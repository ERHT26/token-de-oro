<!DOCTYPE html>
<html lang="es">
<head>
   <link rel="stylesheet" href="estilos.css">
   <!-- Favicon -->
   <link rel="icon" type="image/png" href="favicon.png">
   
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta name="description" content="Consulta el ranking actualizado de futbolistas seg√∫n el sistema Token de Oro. Clasificaci√≥n basada en puntos por rendimiento real en cada partido.">
   <title>RANKING - TOKEN DE ORO</title>
   <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
<!-- Logo de la pagina -->
<div class="logo-integrado">
  <div class="logo-brillo">
    <img src="favicon.png" alt="Logo Token de Oro" />
  </div>
</div>
<nav>
  <ul>
    <li><a href="/" title="Inicio"><i data-lucide="home"></i></a></li>
    <li><a href="/ranking" class="active" title="Ranking"><i data-lucide="trophy"></i></a></li>
    <li><a href="../estadisticas" title="Estad√≠sticas"><i data-lucide="bar-chart-3"></i></a></li>
    <li><a href="../juegos" title="Juegos"><i data-lucide="gamepad-2"></i></a></li>
    <li><a href="https://otieu.com/4/9419626" target="_blank" rel="noopener noreferrer" title="M√°s"><i data-lucide="more-horizontal"></i></a></li>
  </ul>
</nav>

<script>lucide.createIcons();</script>
<header class="trophy-header">
  <div class="header-content">
    <h1>üèÖ Token de Oro üèÖ</h1>
    <h2>Alternativa al Bal√≥n de Oro</h2>
  </div>
</header>

<div id="winner"></div>
<table id="results">
  <tr>
    <th>Jugador</th>
    <th>Desglose de Puntos</th>
    <th>Total Puntos</th>
  </tr>
</table>

<script>
  const API_KEY = '6308d4db454108bc9e980a1784362264';

  const players = [
    {
      name: 'Rodri',
      id: 44,
      collectiveAchievements: {
        championsLeague: 80,
        leagueTop20UEFA: 50,
        nationalCupTop20: 40,
        superCupUEFA: 25,
        clubWorldCup: 30,
        euroCup: 45 // si la gana
      }
    },
    {
      name: 'Vin√≠cius Jr',
      id: 762,
      collectiveAchievements: {
        championsLeague: 80,
        leagueTop20UEFA: 50,
        nationalCupTop20: 40,
        superCupUEFA: 25,
        clubWorldCup: 30
      }
    },
    {
      name: 'Jude Bellingham',
      id: 129718,
      collectiveAchievements: {
        championsLeague: 80,
        leagueTop20UEFA: 50,
        nationalCupTop20: 40
      }
    }
  ];

  const pointsScheme = {
    goals: 14,
    assists: 8,
    dribblesSuccessful: 7,
    shotsOnTargetNoGoal: 3,
    bonusDirectCorner: 6,
    bonusLongDistance: 6,
    bonusAcrobatic: 5,
    bonusFreeKick: 4,
    bonusOutsideArea: 4,
    bonusInsideArea: 2,
    bonusHeader: 3,
    bonusPenalty: 2,
    saves: 10,
    ballRecoveries: 7,
    successfulTacklesBonus: 2,
    bonusPenaltySave: 6,
    bonusAcrobaticSave: 5,
    bonusCloseRangeSave: 4,
    bonusOutsideAreaSave: 3,
    bonusAerialSave: 3,
    matchesPlayed: 5,
    captainLeadership: 3,
    passesCompletedRival: 0.1,
    kmRun: 1,
    foulsCommitted: -2,
    redCards: -8,
    yellowCards: -4,
    simulation: -5,
    noFoulsBonus: 2
  };

  const STORAGE_KEY = 'tokenDeOroPlayerStats';
  const STORAGE_DATE_KEY = 'tokenDeOroStatsDate';

  function isToday(dateString) {
    if (!dateString) return false;
    const savedDate = new Date(dateString);
    const today = new Date();
    return savedDate.getFullYear() === today.getFullYear() &&
           savedDate.getMonth() === today.getMonth() &&
           savedDate.getDate() === today.getDate();
  }

  async function getStats(playerId) {
    // Temporada 2023/2024
    const url = `https://v3.football.api-sports.io/players?id=${playerId}&season=2023`;
    const resp = await fetch(url, {
      headers: { 'x-apisports-key': API_KEY }
    });
    const data = await resp.json();
    if (!data.response || data.response.length === 0) return null;
    return data.response[0].statistics[0];
  }

  async function fetchAndCacheStats() {
    let allStats = {};
    for (const p of players) {
      const stats = await getStats(p.id);
      allStats[p.id] = stats;
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allStats));
    localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
    return allStats;
  }

  function calcCollectivePoints(achievements) {
    let total = 0;
    let breakdown = '';
    for (const [key, value] of Object.entries(achievements)) {
      if (value > 0) {
        const name = collectiveAchievementsNames[key] || key;
        breakdown += `${name}: ${value} pts<br>`;
        total += value;
      }
    }
    return { total, breakdown };
  }

  const collectiveAchievementsNames = {
    championsLeague: 'UEFA Champions League',
    europaLeague: 'UEFA Europa League',
    conferenceLeague: 'UEFA Conference League',
    leagueTop20UEFA: 'Liga en Top 20 UEFA',
    leagueUEFA: 'Liga UEFA (menos Top 20)',
    leagueCONMEBOL: 'Liga CONMEBOL',
    leagueCONCACAF: 'Liga CONCACAF',
    leagueAFC: 'Liga AFC',
    leagueCAF: 'Liga CAF',
    leagueOFC: 'Liga OFC',

    nationalCupTop20: 'Copa Nacional Top 20 UEFA',
    nationalCupUEFA: 'Copa Nacional UEFA',
    nationalCupCONMEBOL: 'Copa Nacional CONMEBOL',
    nationalCupCONCACAF: 'Copa Nacional CONCACAF',
    nationalCupAFC: 'Copa Nacional AFC',
    nationalCupCAF: 'Copa Nacional CAF',
    nationalCupOFC: 'Copa Nacional OFC',

    superCupUEFA: 'Supercopa de la UEFA',
    clubWorldCup: 'Mundial de Clubes',
    libertadores: 'Copa Libertadores',
    sudamericana: 'Copa Sudamericana',
    championsCupCONCACAF: 'Concacaf Champions Cup',
    leaguesCupCONCACAF: 'Leagues Cup',
    championsLeagueAFC: 'AFC Champions League',
    afcCup: 'AFC Cup',
    championsLeagueCAF: 'CAF Champions League',
    confederationCupCAF: 'CAF Confederation Cup',
    championsLeagueOFC: 'OFC Champions League',

    worldCupFIFA: 'Copa Mundial de la FIFA',
    fifaRankingComplete: 'Clasificaci√≥n Mundial FIFA (completada)',
    confederationsCupFIFA: 'Copa Confederaciones FIFA',

    euroCup: 'Eurocopa',
    leagueOfNationsUEFA: 'Liga de Naciones UEFA',

    copaAmerica: 'Copa Am√©rica',

    copaOro: 'Copa Oro CONCACAF',
    leagueOfNationsCONCACAF: 'Liga de Naciones CONCACAF',

    asianCup: 'Copa Asi√°tica',

    afcon: 'Copa Africana de Naciones (AFCON)',

    oceaniaNationsCup: 'Copa de Naciones de Ocean√≠a'
  };

  function calcPoints(stats, player) {
    if (!stats) return { total: 0, details: {}, collective: { total: 0, breakdown: '' } };

    // Variables que no se obtienen de la API por ahora
    const dribbles = 0;
    const recoveries = 0;
    const successfulTackles = 0;
    const passesCompletedRival = 0;
    const kmRun = 0;
    const fouls = 0;
    const simulation = 0;
    const noFouls = false;
    const captain = false;

    let details = {}, total = 0;

    details.goals = stats.goals.total || 0;
    total += details.goals * pointsScheme.goals;

    details.assists = stats.goals.assists || 0;
    total += details.assists * pointsScheme.assists;

    details.dribbles = dribbles;
    total += dribbles * pointsScheme.dribblesSuccessful;

    const shotsOn = stats.shots.on || 0;
    const shotsNoGoal = shotsOn - details.goals;
    details.shotsOnTargetNoGoal = shotsNoGoal > 0 ? shotsNoGoal : 0;
    total += details.shotsOnTargetNoGoal * pointsScheme.shotsOnTargetNoGoal;

    details.saves = stats.goals.saves || 0;
    total += details.saves * pointsScheme.saves;

    details.recoveries = recoveries;
    total += recoveries * pointsScheme.ballRecoveries;

    details.tacklesBonus = successfulTackles;
    total += successfulTackles * pointsScheme.successfulTacklesBonus;

    details.appearances = stats.games.appearences || 0;
    total += details.appearances * pointsScheme.matchesPlayed;

    details.captain = captain ? 1 : 0;
    total += captain ? pointsScheme.captainLeadership : 0;

    details.passesCompletedRival = passesCompletedRival;
    total += passesCompletedRival * pointsScheme.passesCompletedRival;

    details.kmRun = kmRun;
    total += kmRun * pointsScheme.kmRun;

    details.fouls = fouls;
    total += fouls * pointsScheme.foulsCommitted;

    details.yellowCards = stats.cards.yellow || 0;
    total += details.yellowCards * pointsScheme.yellowCards;

    details.redCards = stats.cards.red || 0;
    total += details.redCards * pointsScheme.redCards;

    details.simulation = simulation;
    total += simulation * pointsScheme.simulation;

    details.noFoulsBonus = noFouls ? 1 : 0;
    total += noFouls ? pointsScheme.noFoulsBonus : 0;

    const collective = calcCollectivePoints(player.collectiveAchievements);
    total += collective.total;

    return { total, details, collective };
  }

  function formatDetails(details, collective) {
    return `
      <div class="points-breakdown" style="padding: 0.5rem;">
        <strong>üßç‚Äç‚ôÇÔ∏è Rendimiento Individual</strong>
        <ul style="margin: 0 0 0.5rem 1rem; padding-left: 1rem;">
          <li>Goles: ${details.goals} √ó14 = ${details.goals * 14} pts</li>
          <li>Asistencias: ${details.assists} √ó8 = ${details.assists * 8} pts</li>
          <li>Regates exitosos: ${details.dribbles} √ó7 = ${details.dribbles * 7} pts</li>
          <li>Tiros al arco (sin gol): ${details.shotsOnTargetNoGoal} √ó3 = ${details.shotsOnTargetNoGoal * 3} pts</li>
          <li>Atajadas: ${details.saves} √ó10 = ${details.saves * 10} pts</li>
          <li>Recuperaciones de bal√≥n: ${details.recoveries} √ó7 = ${details.recoveries * 7} pts</li>
          <li>Entradas exitosas: ${details.tacklesBonus} √ó2 = ${details.tacklesBonus * 2} pts</li>
          <li>Partidos jugados: ${details.appearances} √ó5 = ${details.appearances * 5} pts</li>
          <li>Liderazgo como capit√°n: ${details.captain} √ó3 = ${details.captain * 3} pts</li>
          <li>Pases en campo rival: ${details.passesCompletedRival} √ó0.1 = ${(details.passesCompletedRival * 0.1).toFixed(1)} pts</li>
          <li>Kil√≥metros recorridos: ${details.kmRun} √ó1 = ${details.kmRun} pts</li>
          <li>Faltas cometidas: ${details.fouls} √ó(-2) = ${details.fouls * -2} pts</li>
          <li>Amarillas: ${details.yellowCards} √ó(-4) = ${details.yellowCards * -4} pts</li>
          <li>Rojas: ${details.redCards} √ó(-8) = ${details.redCards * -8} pts</li>
          <li>Simulaciones: ${details.simulation} √ó(-5) = ${details.simulation * -5} pts</li>
          <li>Sin faltas (bonus): ${details.noFoulsBonus} √ó2 = ${details.noFoulsBonus * 2} pts</li>
        </ul>

        <strong>üèÜ Logros Colectivos</strong>
        <ul style="margin: 0 0 0.5rem 1rem; padding-left: 1rem;">
          ${collective.breakdown.split('<br>').filter(x => x).map(item => `<li>${item}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  async function load() {
    const table = document.getElementById('results');
    let maxPoints = -Infinity;
    let winner = '';

    // Revisar localStorage para ver si hay datos del d√≠a actual
    const savedDateStr = localStorage.getItem(STORAGE_DATE_KEY);
    let statsCache = null;
    if (savedDateStr && isToday(savedDateStr)) {
      const savedStatsStr = localStorage.getItem(STORAGE_KEY);
      if (savedStatsStr) {
        statsCache = JSON.parse(savedStatsStr);
      }
    }

    if (!statsCache) {
      // No hay datos o son antiguos, obtener de la API y guardar
      statsCache = await fetchAndCacheStats();
    }

    for (const p of players) {
      const stats = statsCache[p.id];

      const row = table.insertRow();
      row.insertCell().textContent = p.name;

      if (!stats) {
        // Si no hay datos, mostrar leyenda en vez de puntos
        row.insertCell().innerHTML = '<em>En proceso de obtenci√≥n de datos...</em>';
        row.insertCell().textContent = '‚Äî';
        continue;
      }

      const { total, details, collective } = calcPoints(stats, p);
      row.insertCell().innerHTML = formatDetails(details, collective);
      row.insertCell().textContent = total.toFixed(2);

      if (total > maxPoints) {
        maxPoints = total;
        winner = p.name;
      }
    }

    const winnerDiv = document.getElementById('winner');
    winnerDiv.innerHTML = `
      <div class="ganador-container">
        <h1>üèÜ Ganador del Token de Oro 2024</h1>
        <div class="ganador-nombre">${winner}</div>
        <div class="ganador-puntos">${maxPoints.toFixed(2)} puntos</div>
      </div>
    `;
  }

  load();
</script>

</body>
</html>
